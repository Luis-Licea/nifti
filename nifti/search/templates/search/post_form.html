{% extends 'home/base.html' %}
{% block title %}
<title>New Ad</title>
{% endblock title %}
{% load crispy_forms_tags %}
{% block content %}
<script>
  window.onload = function onWindowLoadFunctions(){
    setTagsToModifyInput();
  }

  function setTagsToModifyInput(){
    /* 
    when using request.POST.get(nameOfElement), the element must be 
    an input field. So using this input field. 
    */
    document.getElementById("tagsToModifyInput").value = document.getElementById("tagsToModify").innerText.replace(/ /g,"");
  }

  function checkTagLimit(section){
    /*
    Hide Add Tags section if user reaches tag limit of 10.
    */
    var tagCount = document.getElementsByClassName("modifyAddTag").length;
    if(tagCount<10) document.getElementById("addTagSection").style.display="inline";
    else {
      if(section == 'add') alert("Maximum tag count is 10.");
      document.getElementById("addTagSection").style.display="none";
    }
  }
  
  function tagExists(tag,stringTags){
    const str = stringTags.replace(/ /g,"");
    const arrTags = str.split(/[+]/);
    for (var i=0; i<arrTags.length; i++){
      if(tag == arrTags[i]) return true;
    }
    return false;
  }

  function addTag(){
    var tagAddInput = document.getElementById('tagAddInput').value;
    var tagsString = document.getElementById('id_tags_string'); 
    var tagsToMod = document.getElementById('tagsToModify');
    //dissallow tags with '+'.
    //can add more rules for tag entering here
    if (tagAddInput.indexOf('+') != -1){
      alert("'+' is not allowed in a tag.");
      return;
    }
    //add tag
    else if (tagAddInput != "" && tagAddInput != null && !tagExists(tagAddInput, tagsToMod.innerText)) {
      tagsToMod.innerHTML = tagsToMod.innerHTML + 
      '<span type="button" class="modifyAddTag" style="border: 2px solid black; background:#99ff99;border-radius:5px;">+' +
        tagAddInput + 
      '</span>';
    }
    //tag exists
    else if (tagAddInput != "" && tagAddInput != null && tagExists(tagAddInput, tagsToMod.innerText)) {
      alert("Tag: [" + tagAddInput + "] already exists.");
    }
    setTagsToModifyInput();
  }

  function removeTag(){
    var tagRemoveInput = document.getElementById('tagRemoveInput').value;
    var tagsToMod = document.getElementById('tagsToModify');
    const modifyAddTags = document.getElementsByClassName("modifyAddTag");
    //dissallow tags with '+'. 
    //can add more rules for tag entering here
    if (tagRemoveInput.indexOf('+') != -1){
      alert("'+' is not allowed in a tag.");
      return;
    }
    //remove tag
    else if (tagRemoveInput != "" && tagRemoveInput != null && tagExists(tagRemoveInput, tagsToMod.innerText)) {
      for (var i=0; i<modifyAddTags.length; i++){
        if (modifyAddTags[i].innerText.replace(/ /g,"") == '+'+tagRemoveInput) modifyAddTags[i].remove();
      }
    }
    //tag does not exist
    else if (tagRemoveInput != "" && tagRemoveInput != null && !tagExists(tagRemoveInput, tagsToMod.innerText)){
      alert("Tag: [" + tagRemoveInput + "] does not exist.");
    }
    setTagsToModifyInput();
  }
</script>

  <!-- Leave blank space at the top and bottom of the page. -->
  <div style="margin: 3em 0;" >

    <!-- Show registration, post, login, etc messages. -->
    {% include 'home/messages.html' %}

    <form method="post">
      <div class="card text-black" style="margin: auto; max-width: fit-content;">

        <h5 class="card-header">Post Advertisement</h5>

        <!-- Display as grid so button takes entire width. -->
        <div class="card-body d-grid" style="text-align: left">

          {% csrf_token %}
          <!-- Display form. -->
          {{ form | crispy }}
          <!-- Invoke rich text editor. -->
          {{ form.media }}
          <br>
          <!-- Tags -->
          {% if update_post %}
            <div style="padding-left:20px; text-align:left;border: 5px solid black;">
              <p style="text-align: center; padding-right:20px; font-size:20px">Tags</p>
              <!-- Add Tags -->
              <!-- Only up to 10 tags per post -->
              <div id="addTagSection" name="addTagSection">
                <p>Add tags to post:</p>
                <input type="label" id="tagAddInput" name="tagAddInput" maxlength="20">
                <span type="button" onclick="addTag();checkTagLimit('add');" style="border: 2px solid blue; padding:2px; border-radius:5px;">Add Tag</span>
              </div>
              <!-- Remove Tags -->
              <div id="removeTagSection" name="removeTagSection">
                <p style="padding-top: 10px;">Remove tags from post:</p>
                <input type="label" id="tagRemoveInput" name="tagRemoveInput" maxlength="20">
                <span type="button" onclick="removeTag();checkTagLimit('remove');" style="border: 2px solid blue; padding:2px; border-radius:5px;">Remove Tag</span>
              </div>
              <!-- Tag Modifications will be completed after the post is saved. -->
              <!-- Have to use an input field bc Django can only see input HTML fields in request.POST. Keep hidden so users cannot modify. -->
              <input type="label" id="tagsToModifyInput" name="tagsToModifyInput" style="display:none;">
              <p>Tags:</p>
              <div id="tagsToModify" name="tagsToModify" style="background:grey; height:100px; width:200px; overflow: auto;">
                {% for tag in tags %}
                  <span type="button" class="modifyAddTag" style="border: 2px solid black; background:#99ff99;border-radius:5px;">+{{ tag.tag_name }}</span>
                {% endfor %}
              </div>
              <br>
            </div>
            <br>
          {% else %}
            <p style="color:red">Posts can only add tags after creation.</p>
          {% endif %}
          <button type="submit" class="btn btn-primary">Post</button>          
        </div>
      </div>
      <!-- View All Ads by Author Button. -->
    </form>
    <br>
    <a href="{% url 'user-post-list' user %}" class="btn btn-outline-primary" style="display: block; margin-bottom: 0.5rem;" role="button">View My Ads</a>
  </div>


{% endblock content %}